<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AdminFreeDAO">


    <select id="freeList" parameterType="com.esoom.templeate.admin.service.FreeBoardVO" resultType="com.esoom.templeate.admin.service.FreeBoardVO">
		SELECT * , ROW_NUMBER() OVER (ORDER BY A.ref, A.ansnum desc,A.step desc) AS rownum
			FROM (	
					select A.*
					, FORMAT(A.wdate, 'yyyy-MM-dd HH:mm') AS formatted_date
					, KCC_EGIS.egis.FN_MASK_NAME(writer) writer2
					, (SELECT COUNT(*) FROM KCC_EGIS.egis.TBL_FREE_TAIL b WHERE b.info_num = A.num) AS tail_count
					, ROW_NUMBER() OVER (PARTITION BY A.num ORDER BY A.num) AS SEQ
					from (
							select a.*
							from KCC_EGIS.egis.TBL_FREE a 
							where 1=2 
							and a.chk_del = 'N'
							
							<if test='searchTitle =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and a.subject LIKE CONCAT('%', #{searchKeyword}, '%')
									</if>
								</if>
							</if>
							<if test='searchContent =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and CONTAINS(a.content, #{searchKeyword})
									</if>
								</if>
							</if>
							<if test='searchWriter =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and a.writer LIKE CONCAT('%', #{searchKeyword}, '%')
									</if>
								</if>
							</if>
							<if test='searchTail =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
										and a.num in (select distinct info_num FROM KCC_EGIS.egis.TBL_FREE_TAIL where CONTAINS(content, #{searchKeyword}))
									</if>
								</if>
							</if>
							<if test='searchTailWriter =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{chk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
										and a.num in (select distinct info_num FROM KCC_EGIS.egis.TBL_FREE_TAIL where writer LIKE CONCAT('%', #{searchKeyword}, '%'))
									</if>
								</if>
							</if>
							<if test='searchTitle == "N"'>
							    <if test='searchContent == "N"'>
							        <if test='searchWriter == "N"'>
							            <if test='searchTail == "N"'>
							                <if test='searchTailWriter == "N"'>
												union all
												select a.*
												from KCC_EGIS.egis.TBL_FREE a 
												where 1=1 
												<if test="chk_del != null">
													<if test='chk_del != "all"'>
														and a.chk_del = #{searchChk_del}
													</if>
												</if>
											</if>
										</if>
									</if>
								</if>
							</if>
						) A
					) A 
			WHERE A.SEQ = 1
			ORDER BY ref desc, ansnum,step
	</select>
	<select id="getFreeListCount" resultType="int">
		select count(*) from (
		SELECT * 
			FROM (	
					select A.*
					, FORMAT(a.wdate, 'yyyy.MM.dd') AS reg_date
					, KCC_EGIS.egis.FN_MASK_NAME(writer) writer2
					, ROW_NUMBER() OVER (ORDER BY a.num) AS rownum
					, (SELECT COUNT(*) FROM KCC_EGIS.egis.TBL_FREE_TAIL b WHERE b.info_num = a.num) AS tail_count
					, ROW_NUMBER() OVER (PARTITION BY A.num ORDER BY A.num) AS SEQ
					from (
							select a.*
							from KCC_EGIS.egis.TBL_FREE a 
							where 1=2 
							and a.chk_del = 'N'
							
							<if test='searchTitle =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and a.subject LIKE CONCAT('%', #{searchKeyword}, '%')
									</if>
								</if>
							</if>
							<if test='searchContent =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{chk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and CONTAINS(a.content, #{searchKeyword})
									</if>
								</if>
							</if>
							<if test='searchWriter =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
								      	and a.writer LIKE CONCAT('%', #{searchKeyword}, '%')
									</if>
								</if>
							</if>
							<if test='searchTail =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
										and a.num in (select distinct info_num FROM KCC_EGIS.egis.TBL_FREE_TAIL where CONTAINS(content, #{searchKeyword}))
									</if>
								</if>
							</if>
							<if test='searchTailWriter =="Y"'>
								union all
								select a.*
								from KCC_EGIS.egis.TBL_FREE a 
								where 1=1 
								<if test="searchChk_del != null">
									<if test='searchChk_del != "all"'>
										and a.chk_del = #{searchChk_del}
									</if>
								</if>
								<if test="searchKeyword != null">
									<if test='searchKeyword != ""'>
										and a.num in (select distinct info_num FROM KCC_EGIS.egis.TBL_FREE_TAIL where writer LIKE CONCAT('%', #{searchKeyword}, '%'))
									</if>
								</if>
							</if>
							<if test='searchTitle == "N"'>
							    <if test='searchContent == "N"'>
							        <if test='searchWriter == "N"'>
							            <if test='searchTail == "N"'>
							                <if test='searchTailWriter == "N"'>
												union all
												select a.*
												from KCC_EGIS.egis.TBL_FREE a 
												where 1=1 
												<if test="searchChk_del != null">
													<if test='searchChk_del != "all"'>
														and a.chk_del = #{searchChk_del}
													</if>
												</if>
											</if>
										</if>
									</if>
								</if>
							</if>
						) A
					) A 
			WHERE A.SEQ = 1
		) A
	</select>
	<select id="selectFreeDetail" resultType="com.esoom.templeate.admin.service.FreeBoardVO">
		select *,FORMAT(wdate, 'yyyy-MM-dd HH:mm') AS formatted_date
		,KCC_EGIS.egis.FN_MASK_NAME(writer) writer2
		from KCC_EGIS.egis.TBL_FREE
		where
		num = #{num}
	</select>
	<update id="changeChkDel" parameterType="com.esoom.templeate.admin.service.FreeBoardVO">
		update
		KCC_EGIS.egis.TBL_FREE
		set chk_del = #{chk_del}
		where
		num = #{num}

	</update>
	<select id="freeTailList" resultType="com.esoom.templeate.admin.service.FreeTailVO">
		SELECT *
		FROM (
		select num
		,info_num
		,KCC_EGIS.egis.FN_MASK_NAME(writer) writer
		,id
		,writer as writer2
		,content
		,CONVERT(char(10),wdate ,23) wdate
		,FORMAT(wdate , 'yyyy-MM-dd HH:mm') AS formatted_date
		from KCC_EGIS.egis.TBL_FREE_TAIL
		where info_num = #{info_num}
		) A
		ORDER BY num 
	</select>
	<select id="getFreeTailListCount" resultType="int">
		select count(*)
		from (
		select *
		from KCC_EGIS.egis.TBL_FREE_TAIL
		where info_num = #{info_num}
		) A
	</select>
	<insert id="insertFreeTail" parameterType="com.esoom.templeate.admin.service.FreeTailVO">
		insert into KCC_EGIS.egis.TBL_FREE_TAIL values
		(
		#{info_num},#{id},#{writer},#{content},#{ip},getdate()
		)
	</insert>
	<delete id="deleteFreeTail" parameterType="com.esoom.templeate.admin.service.FreeTailVO">
		delete from
		KCC_EGIS.egis.TBL_FREE_TAIL
		where num = #{num}
	</delete>
	<delete id="deleteFree" parameterType="com.esoom.templeate.admin.service.FreeBoardVO">
		delete from
		KCC_EGIS.egis.TBL_FREE
		where num = #{num}
	</delete>
	<update id="mergeFree" parameterType="com.esoom.templeate.admin.service.FreeBoardVO">
		merge into
		KCC_EGIS.egis.TBL_FREE A
		using
		(
		select #{num} AS num
		,#{subject} AS subject
		,#{content} AS content
		,#{flag} AS flag
		,#{id} AS id
		,#{writer} AS writer
		,#{ip} AS ip
		) B
		on A.num = B.num
		WHEN MATCHED THEN
		UPDATE set
		A.subject = B.subject
		,A.content = B.content
		,A.flag = B.flag
		WHEN not MATCHED THEN
		INSERT (
		subject
		,content
		,flag
		,id
		,writer
		,ip
		,wdate
		,chk_del
		,visited
		,ref
		,step
		,ansnum
		,tn
		,pn
		,recommend
		)
		values (
		B.subject
		,B.content
		,B.flag
		,B.id
		,B.writer
		,B.ip
		,getdate()
		,'N'
		,0
		,(SELECT ISNULL(MAX(ref), 0) + 1 FROM KCC_EGIS.egis.TBL_FREE)
		,0
		,0
		,0
		,0
		,0
		);

	</update>
</mapper>